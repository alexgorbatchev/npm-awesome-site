<!DOCTYPE html><head><link rel="alternate" title="RSS" type="application/rss+xml" href="http://feeds.feedburner.com/npmawesome"><link rel="stylesheet" type="text/css" media="all" href="/styles.css"><meta name="viewport" content="initial-scale=1, maximum-scale=1"><meta property="twitter:account_id" content="4503599628039784"><meta charset="utf-8"><title>recluster | npm awesome</title><meta property="og:title" content="recluster"><meta property="og:updated_time" content="1388515513000"><meta property="og:site_name" content="npm awesome"><meta property="og:type" content="blog"><meta property="og:url" content="http://npmawesome.com/posts/2013-12-31-recluster"><meta name="description" content="Clustering library with support for zero-downtime reloading."><meta property="og:description" content="Clustering library with support for zero-downtime reloading."></head><body><div class="container"><div class="row"><h1 id="logo"><a href="/"><span>npm awesome</span><span class="posts-counter">45</span></a></h1><div id="sub-title"><a href="http://npmjs.org">npm</a> picks, old and new.
<a href="https://github.com/alexgorbatchev/npm-awesome-site">Fork on GitHub to contribute</a></div></div><div class="row"><div class="main col"><article><header><h2><a href="/posts/2013-12-31-recluster">recluster</a></h2><div class="meta"><span>posted by <a href="https://github.com/alexgorbatchev">Alex Gorbatchev</a> on December 31st 2013</span><a href="http://npmawesome.com/posts/2013-12-31-recluster#disqus_thread" class="comments"></a><div data-github-repo="doxout/recluster" class="github-stars"></div></div></header><div><p><a href="https://github.com/doxout/recluster">recluster</a> is a clustering library with support for zero-downtime reloading.</p>
<pre><code>npm install recluster</code></pre>
<p><img class="hide-on-mobile" src="/images/posts/recluster.jpg" style="width: 250px; float: right" /></p>
<p>Delivering that 100% uptime for web apps can be a tricky business. Errors and new code rollouts are the things we have to deal with on a daily basis and if you run continuous integration, your app is probably restarting many times a day. What kind of experience this might be creating for your users?</p>
<p><a href="https://github.com/doxout/recluster">recluster</a> is among a <a href="https://github.com/nodejitsu/forever">few</a> <a href="https://github.com/superjoe30/naught">other</a> libraries that try to address this issue. It is:</p>
<ul>
<li>Cluster aware.</li>
<li>Zero downtime errors and deploys.</li>
<li>Does not run as daemon.</li>
<li>Log agnostic.</li>
<li>Simple, relatively easy to reason about.</li>
</ul>
<h2 id="example">Example</h2>
<p>If <code>server.js</code> is your regular http server (e.g. express), create <code>cluster.js</code> and add:</p>
<pre><code>var recluster = require(&#39;recluster&#39;),
    path = require(&#39;path&#39;);

var cluster = recluster(path.join(__dirname, &#39;server.js&#39;));
cluster.run();

process.on(&#39;SIGUSR2&#39;, function() {
    console.log(&#39;Got SIGUSR2, reloading cluster...&#39;);
    cluster.reload();
});

console.log(&quot;spawned cluster, kill -s SIGUSR2&quot;, process.pid, &quot;to reload&quot;);</code></pre>
<p>then run it</p>
<pre><code>node cluster.js</code></pre>
<p>To hot-reload the server, simply run</p>
<pre><code>kill -s SIGUSR2 &lt;cluster_pid&gt;</code></pre>
<p>A server worker can gracefully exit by cleaning up in the &#39;close&#39; event of its server:</p>
<pre><code>server.on(&#39;close&#39;, function() {
    // cleanup
});</code></pre>
<p>Non-server workers can listen for the disconnect command and shut down gracefully before the kill timeout:</p>
<pre><code>process.on(&#39;message&#39;, function(m) {
    if (m.cmd == &#39;disconnect&#39;) {
        // cleanup
    }
})</code></pre>
<p>For some fantastic insights on the subject, checkout <a href="http://sandinmyjoints.github.io/towards-100-pct-uptime">Towards 100% Uptime with Node.js</a> slides by <a href="https://github.com/sandinmyjoints">William Bert</a> <a href="https://twitter.com/williamjohnbert">@williamjohnbert</a> and <a href="http://qzaidi.github.io/2013/05/14/node-in-production/">10 steps to nodejs nirvana in production</a> by <a href="http://github.com/qzaidi">Qasim Zaidi</a> <a href="http://twitter.com/#!/kernelhacker">@kernelhacker</a>.</p>
<p>Curious, how do you manage your node process?</p>
</div></article><div id="disqus_thread"></div><script type="text/javascript">/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
var disqus_shortname = 'npmawesome'; // required: replace example with your forum shortname

/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script></div><aside class="col"><div class="feedburner"><a href="http://feeds.feedburner.com/npmawesome"><img src="/images/feed.gif"></a></div><div class="other-posts"><h4>Previously...</h4><div><a href="/posts/2014-01-31-coupon-code">coupon-code</a></div><div><a href="/posts/2014-01-30-rewire">rewire</a></div><div><a href="/posts/2014-01-29-yarm">yarm</a></div><div><a href="/posts/2014-01-28-modella">modella</a></div><div><a href="/posts/2014-01-27-mversion">mversion</a></div><div><a href="/posts/2014-01-24-schema-inspector">schema-inspector</a></div><div><a href="/posts/2014-01-23-oboe-js">oboe.js</a></div><div><a href="/posts/2014-01-22-autoprefixer">autoprefixer</a></div><div><a href="/posts/2014-01-21-js-yaml">js-yaml</a></div><div><a href="/posts/2014-01-17-gaze">gaze</a></div><div><a href="/posts/2014-01-14-shortid">shortId</a></div><div><a href="/posts/2014-01-13-testium">testium</a></div><div><a href="/posts/2014-01-10-messageformat">messageformat.js</a></div><div><a href="/posts/2014-01-09-gulp">gulp</a></div><div><a href="/posts/2014-01-06-chalk">chalk</a></div><div class="current"><a href="/posts/2013-12-31-recluster">recluster</a></div><div><a href="/posts/2013-12-30-rework">rework</a></div><div><a href="/posts/2013-12-27-cheerio">cheerio</a></div><div><a href="/posts/2013-12-19-dat">dat</a></div><div><a href="/posts/2013-12-18-xregexp">xregexp</a></div><div><a href="/posts/2013-12-16-ect">ect</a></div><div><a href="/posts/2013-12-13-chrono">chrono</a></div><div><a href="/posts/2013-12-11-prettyjson">prettyjson</a></div><div><a href="/posts/2013-12-10-state">state</a></div><div><a href="/posts/2013-12-09-blessed">blessed</a></div><div><a href="/posts/2013-12-05-gm">gm</a></div><div><a href="/posts/2013-12-03-nak">nak</a></div><div><a href="/posts/2013-12-03-verymodel">VeryModel</a></div><div><a href="/posts/2013-11-26-rx-js">rx.js</a></div><div><a href="/posts/2013-11-26-docpad">docpad</a></div><div><a href="/posts/2013-11-25-grunt-angular-builder">grunt-angular-builder</a></div><div><a href="/posts/2013-11-22-event-stream">event-stream</a></div><div><a href="/posts/2013-11-21-bacon-js">bacon.js</a></div><div><a href="/posts/2013-11-20-spdy">node-spdy</a></div><div><a href="/posts/2013-11-19-json-mask">json-mask</a></div><div><a href="/posts/2013-11-18-pm2">pm2</a></div><div><a href="/posts/2013-11-18-npmd">npmd</a></div><div><a href="/posts/2013-11-18-nixt">nixt</a></div><div><a href="/posts/2013-11-17-vm-js">vm.js</a></div><div><a href="/posts/2013-11-17-node-jvm">node-jvm</a></div><div><a href="/posts/2013-11-17-flake">flake</a></div></div></aside></div></div><a id="fork-me" href="https://github.com/alexgorbatchev/npm-awesome-site" class="hide-on-mobile">Fork Me</a></body><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

// http://drawingablank.me/blog/fix-your-bounce-rate.html
// https://news.ycombinator.com/item?id=5766883
setTimeout(function() {
  window.onscroll = function() {
    window.onscroll = null; // Only track the event once
    ga('send', 'scroll', 'read');
  }
}, 5000);

ga('create', 'UA-46164085-1', 'npmawesome.com');
ga('send', 'pageview');
</script><script src="http://cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script><script src="/scripts/npmawesome.bundle.js"></script>