<!DOCTYPE html><head><link rel="alternate" title="RSS" type="application/rss+xml" href="http://feeds.feedburner.com/npmawesome"><link rel="stylesheet" type="text/css" media="all" href="/styles.css"><meta name="viewport" content="initial-scale=1, maximum-scale=1"><meta charset="utf-8"><title>vm.js | npm awesome</title><meta property="og:title" content="vm.js"><meta property="og:updated_time" content="1384730401275"><meta property="og:site_name" content="npm awesome"><meta property="og:type" content="blog"><meta property="og:url" content="http://npmawesome.com/posts/2013-11-17-vm-js"><meta name="description" content="Daily dose of awesome NPM modules for Node.js, old and new!"><meta property="og:description" content="Daily dose of awesome NPM modules for Node.js, old and new!"></head><body><div class="container"><div class="row"><h1 id="logo"><a href="/"><span>npm awesome</span><span class="posts-counter">29</span></a></h1><div id="sub-title"><a href="http://npmjs.org">npm</a> picks, old and new by <a href="https://github.com/alexgorbatchev">Alex Gorbatchev</a><p><a href="http://feeds.feedburner.com/npmawesome"><img src="/images/feed.gif"></a></p></div></div><div class="row"><div class="main col"><article><header><h2><a href="/posts/2013-11-17-vm-js">vm.js</a></h2><div class="meta"><span>posted by <a href="https://github.com/alexgorbatchev">Alex Gorbatchev</a> on November 17th 2013</span><a href="/posts/2013-11-17-vm-js#disqus_thread" class="comments"></a></div></header><div><p><a href="https://github.com/tarruda/vm.js">vm.js</a> is a pretty impressive fully
functional ECMAScript virtual machine that can be used from any
ECMAScript3-compatible environment. Eventually it will provide a
complete ECMAScript 6 environment (for now only some features are
supported).</p>
<pre><code>npm install vm.js</code></pre>
<p>It’s written in CoffeeScript and has plenty of tests. The most
impressive thing is that the tests themselves run inside <code>vm.js</code>.</p>
<p>Here are some possible use cases:</p>
<ul>
<li>Simple in-process javascript sandbox</li>
<li>Async-to-sync API adapter using fibers (lightweight in-process
threads, not node.js fibers)</li>
<li>Use new ECMAScript features in very old browsers</li>
</ul>
<p>The main API can be accessed through vm instances. Each vm is indirectly
associated with a global object (through a “realm”) and is isolated from
other vms.</p>
<p>Start by creating a new instance:</p>
<pre><code>&gt; Vm = require(&#39;vm.js&#39;)
&gt; vm = new Vm()</code></pre>
<p>Evaluate simple expressions:</p>
<pre><code>&gt; vm.eval(&#39;40 + 2&#39;)
42
&gt; vm.eval(&#39;[a, b, c] = [1, 2, 3]&#39;) // Harmony destructuring assignment
[1, 2, 3]
&gt; vm.realm.global.a
1
&gt; vm.realm.global.b
2
&gt; vm.realm.global.c
3</code></pre>
<p>Compile programs and run later</p>
<pre><code>// pass filename as second argument for stack traces/debugging
&gt; script = Vm.compile(&#39;2 + 2&#39;, &#39;sum.js&#39;)
&gt; vm.run(script)
4</code></pre>
<p>Compiled scripts can be serialized/deserialized to/from JSON-friendly
structures:</p>
<pre><code>&gt; scriptObj = script.toJSON()
&gt; serializedScript = JSON.stringify(scriptObj)
&gt; deserializedScript = Vm.fromJSON(JSON.parse(serializedScript))
&gt; vm.run(deserializedScript)</code></pre>
<p>Expose objects to be used by code running inside the Vm</p>
<pre><code>&gt; vm.realm.global.factorial = function factorial(n) { return n &gt; 1 ? factorial(n - 1) * n : 1 }
&gt; vm.eval(&#39;factorial(5)&#39;)
120</code></pre>
<p>The inverse also works:</p>
<pre><code>&gt; vm.eval(&#39;function factorial(n) { return n &gt; 1 ? factorial(n - 1) * n : 1 }&#39;)
&gt; vm.realm.global.factorial(5)
120</code></pre>
<p>Return values asynchronously using fiber pause/resume:</p>
<pre><code>// created a paused fiber from compiled code
fiber = vm.createFiber(Vm.compile(&#39;user = null; user = fetchAsync(&quot;/users/1&quot;);&#39;))
vm.realm.global.fetchAsync = function(url) {
  fiber.pause() // pause execution
  $.get(url, function(data) {
    // user === null
    fiber.setReturnValue(data)
    fiber.resume()
    // user === data
  });
}
// start fiber
fiber.run()</code></pre>
<p>There are plenty of examples on the <a href="https://github.com/tarruda/vm.js">github
page</a>.</p>
</div></article><div id="disqus_thread"></div><script type="text/javascript">/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
var disqus_shortname = 'npmawesome'; // required: replace example with your forum shortname

/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script></div></div></div><a id="fork-me" href="https://github.com/alexgorbatchev/npm-awesome-site">Fork Me</a></body><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-46164085-1', 'npmawesome.com');
ga('send', 'pageview');
</script><script src="http://cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script><script src="/scripts/npmawesome.bundle.js"></script>